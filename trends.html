<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trends</title>

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<style>
  .listBtn{
    display: inline-block;
    border-radius: 10px;
    color: white;
    background: green;
}
/* Button styling */
.btn {
  padding: 8px 16px;
  margin-right: 10px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
}

.btn:hover {
  background-color: #45a049;
}

/* Table styling */
.styled-table {
  width: 100%;
  border-collapse: collapse;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}

.styled-table thead tr {
  background-color: #009879;
  color: #ffffff;
  text-align: left;
  font-weight: bold;
}

.styled-table th, .styled-table td {
  padding: 12px 0px;
}

.styled-table tbody tr {
  border-bottom: 1px solid #dddddd;
  background-color: #f3f3f3;
  transition: background-color 0.2s;
}

.styled-table tbody tr:nth-of-type(even) {
  background-color: #e9e9e9;
}

.styled-table tbody tr:hover {
  background-color: #d1e7dd;
}

.styled-table tbody tr:last-of-type {
  border-bottom: 2px solid #009879;
}

/* Responsive */
@media screen and (max-width: 600px) {
  .styled-table thead {
    display: none;
  }

  .styled-table, .styled-table tbody, .styled-table tr, .styled-table td {
    display: block;
    width: 100%;
  }

  .styled-table tr {
    margin-bottom: 15px;
    border-bottom: 2px solid #009879;
  }

  .styled-table td {
    text-align: right;
    padding-left: 50%;
    position: relative;
  }

  .styled-table td::before {
    content: attr(data-label);
    position: absolute;
    left: 15px;
    width: 45%;
    padding-left: 15px;
    font-weight: bold;
    text-align: left;
  }
}

.table-responsive {
  width: 100%;
  overflow-x: auto; /* horizontal scroll on small screens */
  -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
}

.styled-table {
  width: 100%;
  min-width: 400px; /* ensures table doesn’t collapse */
  border-collapse: collapse;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}

.styled-table thead tr {
  background-color: #009879;
  color: #ffffff;
  text-align: left;
  font-weight: bold;
}

.styled-table th, .styled-table td {
  padding: 12px 15px;
}

.styled-table tbody tr {
  border-bottom: 1px solid #dddddd;
  background-color: #f3f3f3;
  transition: background-color 0.2s;
}

.styled-table tbody tr:nth-of-type(even) {
  background-color: #e9e9e9;
}

.styled-table tbody tr:hover {
  background-color: #d1e7dd;
}

.styled-table tbody tr:last-of-type {
  border-bottom: 2px solid #009879;
}

/* Buttons styling */
.btn {
  padding: 8px 16px;
  margin-right: 10px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
}

.btn:hover {
  background-color: #45a049;
}


</style>
<header>
  <h2>Monthly Trends</h2>
  <a href="index.html">⬅ Back</a>
</header>

<main>
  <label>
    Select Month:
    <input type="month" id="monthPicker">
  </label>

  <canvas id="monthlyChart"></canvas>

  <div class="info">
    <p><strong>Total entries this month:</strong> <span id="totalCount">0</span></p>
    <p><strong>Most active time frame:</strong> <span id="activeTime">—</span></p>
    <p><strong>Most active day:</strong> <span id="activeDay">—</span></p>
  </div>

  <div style="margin-top:20px;">
  <button id="showListBtn" class="listBtn">List</button>
  <button id="hideListBtn" class="listBtn" style="display:none;">Hide List</button>
</div>

<div id="eventsList" style="display:none; margin-top:10px;">
  <div class="table-responsive">
    <table id="eventsTable" class="styled-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>



</main>

<script src="db.js"></script>
<script src="analytics.js"></script>

<script>
let chart;

const WEEK_DAYS = [
  "Sunday", "Monday", "Tuesday", "Wednesday",
  "Thursday", "Friday", "Saturday"
];

document.getElementById("monthPicker").addEventListener("change", e => {
  const [year, month] = e.target.value.split("-").map(Number);
  getAllEvents(events => analyzeMonth(events, year, month - 1));
});

function analyzeMonth(events, year, month) {
  const daily = {};
  const weekDays = {
    "Monday": 0,
    "Tuesday": 0,
    "Wednesday": 0,
    "Thursday": 0,
    "Friday": 0,
    "Saturday": 0,
    "Sunday": 0
  };

  const timeFrames = {
    "6–9 AM": 0,
    "9 AM–7 PM": 0,
    "7–11 PM": 0,
    "11 PM–6 AM": 0
  };

  let total = 0;

  events.forEach(e => {
    if (e.type !== "INCREMENT") return;

    const d = new Date(e.timestamp);

    // ✅ Month filter FIRST
    if (d.getFullYear() !== year || d.getMonth() !== month) return;

    total++;

    // Day-of-month for graph
    const day = d.getDate();
    daily[day] = (daily[day] || 0) + 1;

    // Day-of-week
    const weekDayName = [
      "Sunday","Monday","Tuesday","Wednesday",
      "Thursday","Friday","Saturday"
    ][d.getDay()];
    weekDays[weekDayName]++;

    // Time frame
    const h = d.getHours();
    if (h >= 6 && h < 9) timeFrames["6–9 AM"]++;
    else if (h >= 9 && h < 19) timeFrames["9 AM–7 PM"]++;
    else if (h >= 19 && h < 23) timeFrames["7–11 PM"]++;
    else timeFrames["11 PM–6 AM"]++;
  });

  renderChart(daily);
  updateSummary(weekDays, timeFrames, total);
}


function renderChart(data) {
  const ctx = document.getElementById("monthlyChart");
  if (chart) chart.destroy();

 chart = new Chart(ctx, {
  type: "line",
  data: {
    labels: Object.keys(data),
    datasets: [{
      label: "Daily Count",
      data: Object.values(data),
      tension: 0.3,
      backgroundColor: "#FE9900",
      borderColor: "#FE9900",
      fill: false
    }]
  },
  options: {
    scales: {
      y: {
        ticks: {
          stepSize: 1
        },
        beginAtZero: true
      }
    }
  }
});

}

function updateSummary(weekDays, timeFrames, total) {
  document.getElementById("totalCount").innerText = total;

  const activeTime = Object.entries(timeFrames)
    .sort((a, b) => b[1] - a[1])[0]?.[0] || "—";

  document.getElementById("activeTime").innerText = activeTime;

  const activeWeekDay = Object.entries(weekDays)
    .sort((a, b) => b[1] - a[1])[0]?.[0] || "—";

  document.getElementById("activeDay").innerText = activeWeekDay;
}

  const monthPicker = document.getElementById("monthPicker");

// Set current month as default
const now = new Date();
monthPicker.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;

// Trigger initial load
monthPicker.dispatchEvent(new Event("change"));

 // const monthPicker = document.getElementById("monthPicker");

window.onDbReady = () => {
  const now = new Date();
  monthPicker.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  monthPicker.dispatchEvent(new Event("change"));
};


const showListBtn = document.getElementById("showListBtn");
const hideListBtn = document.getElementById("hideListBtn");
const eventsListDiv = document.getElementById("eventsList");
const eventsTableBody = document.querySelector("#eventsTable tbody");

showListBtn.addEventListener("click", () => {
  eventsListDiv.style.display = "block";
  showListBtn.style.display = "none";
  hideListBtn.style.display = "inline-block";
  renderEventsList();
});

hideListBtn.addEventListener("click", () => {
  eventsListDiv.style.display = "none";
  hideListBtn.style.display = "none";
  showListBtn.style.display = "inline-block";
});

// Render the events for the selected month
function renderEventsList() {
  const [year, month] = monthPicker.value.split("-").map(Number);
  getAllEvents(events => {
    // Filter for selected month
    const monthEvents = events.filter(e => {
      const d = new Date(e.timestamp);
      return d.getFullYear() === year && d.getMonth() === (month - 1);
    });

    // Sort latest first
    monthEvents.sort((a, b) => b.timestamp - a.timestamp);

    // Clear existing rows
    eventsTableBody.innerHTML = "";

    // Populate table
   monthEvents.forEach((e, index) => {
  const tr = document.createElement("tr");
  const dateStr = new Date(e.timestamp).toLocaleString();
  tr.innerHTML = `
    <td data-label="Date">${dateStr}</td>
  `;
  eventsTableBody.appendChild(tr);
});

  });
}


</script>


</body>
</html>
